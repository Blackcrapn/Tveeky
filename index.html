<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tveeky Ultra</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --bl: #3390ec; --bg: #f4f4f5; --si: #fff; --tx: #000; --mi: #fff; --mo: #eeffde; --br: #dfe1e5; }
        [data-theme="dark"] { --bg: #0f0f0f; --si: #1c1c1c; --tx: #fff; --mi: #2b2b2b; --mo: #3d6a97; --br: #333; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.1s; }
        body, html { margin: 0; padding: 0; height: 100%; background: var(--bg); color: var(--tx); overflow: hidden; }
        .hidden { display: none !important; }

        /* AUTH SCREEN */
        #auth-screen { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .auth-card { width: 340px; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center; background: #fff; color: #000; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; outline: none; background: #fff; color: #000; }
        button { width: 100%; padding: 14px; background: var(--bl); color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .tgl { color: var(--bl); cursor: pointer; font-size: 13px; margin-top: 15px; display: block; }

        /* APP STRUCTURE */
        #app { display: flex; height: 100vh; }
        .sidebar { width: 380px; background: var(--si); border-right: 1px solid var(--br); display: flex; flex-direction: column; }
        .side-h { padding: 15px; border-bottom: 1px solid var(--br); display: flex; flex-direction: column; gap: 10px; }
        .side-h-top { display: flex; justify-content: space-between; align-items: center; }
        .search-bar { position: relative; }
        .search-bar input { padding-left: 40px; background: var(--bg); border: none; height: 35px; border-radius: 10px; }
        .search-bar i { position: absolute; left: 10px; top: 8px; color: #888; }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid var(--br); }
        .chat-item:hover { background: rgba(0,0,0,0.03); }
        .chat-item img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; }
        .chat-info { flex: 1; }
        .chat-info b { display: block; }

        .chat-win { flex: 1; display: flex; flex-direction: column; background-size: cover; background-position: center; }
        .chat-h { padding: 10px 20px; background: var(--si); display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--br); }
        .chat-h img { width: 40px; height: 40px; border-radius: 50%; }

        .msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px; border-radius: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 15px; }
        .msg.sent { align-self: flex-end; background: var(--mo); border-bottom-right-radius: 2px; }
        .msg.rcvd { align-self: flex-start; background: var(--mi); border-bottom-left-radius: 2px; }
        .msg img, .msg video { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; display: block; }
        .msg-t { font-size: 10px; opacity: 0.5; text-align: right; margin-top: 4px; }

        .input-bar { padding: 12px; background: var(--si); display: flex; align-items: center; gap: 12px; border-top: 1px solid var(--br); }
        .input-bar input { flex: 1; border: none; background: var(--bg); padding: 12px; border-radius: 20px; color: var(--tx); outline: none; }

        /* MEDIA VIEWER */
        #viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .v-tools { position: absolute; top: 20px; right: 20px; color: #fff; display: flex; gap: 20px; cursor: pointer; }
        #v-content img, #v-content video { max-width: 90vw; max-height: 85vh; border-radius: 10px; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000; display: none; justify-content: center; align-items: center; }
        .modal-c { background: var(--si); padding: 25px; border-radius: 20px; width: 350px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h2 style="color:var(--bl)">Tveeky</h2>
        <div id="auth-box">
            <input type="text" id="a-user" placeholder="Логин (username)">
            <input type="password" id="a-pass" placeholder="Пароль">
            <div id="r-fields" class="hidden">
                <input type="text" id="a-name" placeholder="Имя профиля">
                <textarea id="a-bio" placeholder="О себе..."></textarea>
            </div>
            <button onclick="handleAuth()">Продолжить</button>
            <span class="tgl" onclick="tglA()">Нужен новый аккаунт?</span>
        </div>
    </div>
</div>

<div id="app" class="hidden">
    <div class="sidebar">
        <div class="side-h">
            <div class="side-h-top">
                <i class="material-icons" style="cursor:pointer" onclick="opM('set-mod')">menu</i>
                <b>Tveeky</b>
                <i class="material-icons" style="cursor:pointer" onclick="opM('add-mod')">add</i>
            </div>
            <div class="search-bar">
                <i class="material-icons">search</i>
                <input type="text" placeholder="Поиск..." oninput="searchChats(this.value)">
            </div>
        </div>
        <div class="chat-list" id="chats"></div>
    </div>

    <div class="chat-win" id="chat-bg">
        <div id="h-ui" class="chat-h hidden">
            <img id="h-img" src="">
            <div class="chat-info"><b id="h-name"></b><small id="h-type" style="opacity:0.6"></small></div>
        </div>
        <div class="msgs" id="msgs"></div>
        <div class="input-bar hidden" id="input-ui">
            <label for="f-up"><i class="material-icons" style="cursor:pointer;color:#888">attach_file</i></label>
            <input type="file" id="f-up" hidden onchange="upFile(this)">
            <input type="text" id="m-in" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') sendMsg()">
            <i class="material-icons" style="color:var(--bl);cursor:pointer;font-size:30px" onclick="sendMsg()">send</i>
        </div>
    </div>
</div>

<div id="viewer" onclick="this.style.display='none'">
    <div class="v-tools">
        <i class="material-icons" onclick="saveF(event)">download</i>
        <i class="material-icons">close</i>
    </div>
    <div id="v-content"></div>
</div>

<div id="add-mod" class="modal" onclick="clM('add-mod')">
    <div class="modal-c" onclick="event.stopPropagation()">
        <h3>Создать чат</h3>
        <input type="text" id="g-na" placeholder="Название">
        <select id="g-ty" style="width:100%; padding:10px; margin-bottom:15px; border-radius:10px;">
            <option value="group">Группа</option>
            <option value="channel">Канал</option>
        </select>
        <button onclick="createChat()">Создать</button>
    </div>
</div>

<div id="set-mod" class="modal" onclick="clM('set-mod')">
    <div class="modal-c" onclick="event.stopPropagation()">
        <h3>Настройки</h3>
        <input type="text" id="s-ni" placeholder="Имя">
        <input type="text" id="s-us" placeholder="Username">
        <textarea id="s-bio" placeholder="О себе"></textarea>
        <input type="text" id="s-bg" placeholder="URL обоев чата">
        <button onclick="themeToggle()">Сменить тему</button>
        <button onclick="updateProfile()" style="margin-top:5px">Сохранить</button>
        <button onclick="sb.auth.signOut().then(()=>location.reload())" style="background:#f44;margin-top:10px">Выйти</button>
    </div>
</div>

<script>
const SB_URL = 'https://ljzhlookpjiphhtzpjzw.supabase.co';
const SB_KEY = 'sb_publishable_2qdD5EqmWHelUvtAXiZsWA_5HEuphMS';
const sb = supabase.createClient(SB_URL, SB_KEY);
let me, activeChat, isR = false, curFile;

function tglA() {
    isR = !isR;
    document.getElementById('r-fields').classList.toggle('hidden', !isR);
}

async function handleAuth() {
    const user = document.getElementById('a-user').value, pass = document.getElementById('a-pass').value;
    const name = document.getElementById('a-name').value, bio = document.getElementById('a-bio').value;
    const fakeEmail = `${user}@tveeky.com`;

    if(isR) {
        const { data, error } = await sb.auth.signUp({ email: fakeEmail, password: pass });
        if(error) return alert("Ошибка: " + error.message);
        await sb.from('profiles').insert({ id: data.user.id, username: user, full_name: name, bio: bio });
        alert("Успех! Теперь войдите."); location.reload();
    } else {
        const { error } = await sb.auth.signInWithPassword({ email: fakeEmail, password: pass });
        if(error) return alert("Неверный логин или пароль!");
        location.reload();
    }
}

async function start() {
    const { data: { session } } = await sb.auth.getSession();
    if(!session) return; me = session.user;
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    
    const { data: p } = await sb.from('profiles').select('*').eq('id', me.id).single();
    if(p) {
        document.getElementById('s-ni').value = p.full_name;
        document.getElementById('s-us').value = p.username;
        document.getElementById('s-bio').value = p.bio;
        if(p.chat_wallpaper) document.getElementById('chat-bg').style.backgroundImage = `url(${p.chat_wallpaper})`;
    }
    
    loadChats();
    sb.channel('any').on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},pl => {
        if(activeChat && pl.new.chat_id === activeChat.id) renderMsg(pl.new);
    }).subscribe();
}

async function loadChats() {
    const { data } = await sb.from('chats').select('*').order('created_at', {ascending: false});
    const l = document.getElementById('chats'); l.innerHTML = '';
    data?.forEach(c => {
        const d = document.createElement('div'); d.className = 'chat-item';
        d.innerHTML = `<img src="https://ui-avatars.com/api/?name=${c.name}&background=random">
            <div class="chat-info"><b>${c.name}</b><small>${c.type}</small></div>`;
        d.onclick = () => openChat(c);
        l.appendChild(d);
    });
}

function openChat(c) {
    activeChat = c;
    document.getElementById('h-ui').classList.remove('hidden');
    document.getElementById('input-ui').classList.remove('hidden');
    document.getElementById('h-name').innerText = c.name;
    document.getElementById('h-type').innerText = c.type;
    document.getElementById('h-img').src = `https://ui-avatars.com/api/?name=${c.name}&background=random`;
    loadMsgs();
}

async function loadMsgs() {
    const { data } = await sb.from('messages').select('*').eq('chat_id', activeChat.id).order('created_at');
    document.getElementById('msgs').innerHTML = '';
    data?.forEach(renderMsg);
}

function renderMsg(m) {
    const isMe = m.user_id === me.id;
    const d = document.createElement('div'); d.className = `msg ${isMe?'sent':'rcvd'}`;
    let h = '';
    if(m.media_url) {
        if(m.media_type === 'image') h += `<img src="${m.media_url}" onclick="showMedia('${m.media_url}','i')">`;
        else h += `<video src="${m.media_url}" onclick="showMedia('${m.media_url}','v')"></video>`;
    }
    if(m.content) h += `<div>${m.content}</div>`;
    h += `<div class="msg-t">${new Date(m.created_at).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} ✓✓</div>`;
    d.innerHTML = h; const b = document.getElementById('msgs'); b.appendChild(d); b.scrollTop = b.scrollHeight;
}

async function sendMsg() {
    const i = document.getElementById('m-in'); if(!i.value || !activeChat) return;
    await sb.from('messages').insert({ chat_id: activeChat.id, user_id: me.id, content: i.value });
    i.value = '';
}

async function upFile(el) {
    const f = el.files[0], path = `m/${Date.now()}_${f.name}`;
    await sb.storage.from('tveeky-media').upload(path, f);
    const { data } = sb.storage.from('tveeky-media').getPublicUrl(path);
    await sb.from('messages').insert({ chat_id: activeChat.id, user_id: me.id, media_url: data.publicUrl, media_type: f.type.includes('image')?'image':'video'});
}

function showMedia(u, t) {
    curFile = u; const c = document.getElementById('v-content');
    c.innerHTML = t === 'i' ? `<img src="${u}">` : `<video src="${u}" controls autoplay></video>`;
    document.getElementById('viewer').style.display = 'flex';
}

function saveF(e) { e.stopPropagation(); window.open(curFile, '_blank'); }

async function searchChats(v) {
    const { data } = await sb.from('chats').select('*').ilike('name', `%${v}%`);
    const l = document.getElementById('chats'); l.innerHTML = '';
    data?.forEach(c => {
        const d = document.createElement('div'); d.className = 'chat-item';
        d.innerHTML = `<img src="https://ui-avatars.com/api/?name=${c.name}&background=random"><div class="chat-info"><b>${c.name}</b><small>${c.type}</small></div>`;
        d.onclick = () => openChat(c); l.appendChild(d);
    });
}

async function createChat() {
    const n = document.getElementById('g-na').value, t = document.getElementById('g-ty').value;
    await sb.from('chats').insert({ name: n, type: t, owner_id: me.id });
    clM('add-mod'); loadChats();
}

async function updateProfile() {
    const { error } = await sb.from('profiles').update({ 
        full_name: document.getElementById('s-ni').value, 
        username: document.getElementById('s-us').value, 
        bio: document.getElementById('s-bio').value,
        chat_wallpaper: document.getElementById('s-bg').value 
    }).eq('id', me.id);
    if(error) alert("Ошибка! Возможно, username занят."); else location.reload();
}

function themeToggle() {
    document.body.toggleAttribute('data-theme');
    localStorage.setItem('theme', document.body.hasAttribute('data-theme')?'dark':'light');
}

function opM(id) { document.getElementById(id).style.display = 'flex'; }
function clM(id) { document.getElementById(id).style.display = 'none'; }
if(localStorage.getItem('theme')==='dark') document.body.setAttribute('data-theme','dark');
start();
</script>
</body>
</html>
