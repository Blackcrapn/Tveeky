<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tveeky Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --tg-blue: #3390ec;
            --tg-bg: #f4f4f5;
            --msg-out: #eeffde;
            --msg-in: #ffffff;
            --text-main: #000000;
        }

        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }

        /* Экраны */
        .screen { display: none; height: 100vh; width: 100vw; }
        .screen.active { display: flex; }

        /* Авторизация */
        #auth-screen { background: var(--tg-bg); justify-content: center; align-items: center; }
        .auth-card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 320px; text-align: center; }
        .auth-card h1 { color: var(--tg-blue); margin-bottom: 20px; }
        input[type="text"], input[type="email"], input[type="password"] { 
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; 
        }
        button { 
            width: 100%; padding: 12px; background: var(--tg-blue); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px;
        }

        /* Главный интерфейс */
        .main-container { display: flex; width: 100%; height: 100%; }
        
        /* Боковая панель */
        .sidebar { width: 350px; border-right: 1px solid #dfe1e5; display: flex; flex-direction: column; background: white; }
        .sidebar-header { padding: 15px; background: white; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; }
        .my-profile { display: flex; align-items: center; cursor: pointer; }
        .my-profile img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #f4f4f5; }
        .chat-item.active { background: var(--tg-blue); color: white; }
        .chat-item img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }

        /* Окно чата */
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #e6ebee; position: relative; }
        .chat-header { padding: 10px 20px; background: white; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; }
        
        .messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 12px; position: relative; font-size: 15px; line-height: 1.4; }
        .msg.sent { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
        .msg img, .msg video { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        
        .msg-info { display: flex; justify-content: flex-end; align-items: center; font-size: 11px; color: #687a86; margin-top: 4px; }
        .tick { margin-left: 4px; color: var(--tg-blue); }

        .input-bar { padding: 15px; background: white; display: flex; align-items: center; gap: 10px; }
        .input-bar input { flex: 1; border: none; padding: 10px; font-size: 16px; outline: none; }

        /* Модальные окна */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; width: 350px; position: relative; }
        
        /* Просмотр медиа */
        .viewer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center; }
        .viewer img, .viewer video { max-width: 90%; max-height: 80%; }
        .viewer-tools { position: absolute; top: 20px; right: 20px; display: flex; gap: 20px; color: white; }
        .viewer-tools i { cursor: pointer; font-size: 30px; }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen active">
        <div class="auth-card">
            <h1 id="auth-title">Tveeky</h1>
            <div id="reg-inputs" style="display: none;">
                <input type="text" id="reg-nickname" placeholder="Ник (для людей)">
                <input type="text" id="reg-username" placeholder="Уникальный @username">
            </div>
            <input type="email" id="auth-email" placeholder="Email">
            <input type="password" id="auth-pass" placeholder="Пароль">
            <button onclick="handleAuth()" id="btn-auth">Войти</button>
            <p style="cursor:pointer; color: var(--tg-blue); font-size: 14px;" onclick="toggleAuth()">Создать аккаунт</p>
        </div>
    </div>

    <div id="screen-main" class="screen">
        <div class="main-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="my-profile" onclick="showSettings()">
                        <img id="my-ava" src="https://via.placeholder.com/40">
                        <span id="my-name">Загрузка...</span>
                    </div>
                    <i class="material-icons" style="cursor:pointer" onclick="showCreateChat()">add_comment</i>
                </div>
                <div class="chat-list" id="chat-list"></div>
            </div>

            <div class="chat-window">
                <div id="chat-header" class="chat-header" style="visibility: hidden;">
                    <img id="chat-icon" src="">
                    <div>
                        <div id="chat-title" style="font-weight: bold;">Чат</div>
                        <div style="font-size: 12px; color: #888;">online</div>
                    </div>
                </div>
                
                <div class="messages-area" id="msg-container">
                    <div style="margin: auto; color: #888;">Выберите чат, чтобы начать</div>
                </div>

                <div class="input-bar" id="input-bar" style="display: none;">
                    <label for="file-up"><i class="material-icons" style="cursor:pointer; color: #888;">attach_file</i></label>
                    <input type="file" id="file-up" hidden onchange="uploadMedia(this)">
                    <input type="text" id="msg-input" placeholder="Сообщение...">
                    <i class="material-icons" style="color: var(--tg-blue); cursor:pointer;" onclick="sendText()">send</i>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-settings" class="modal">
        <div class="modal-content">
            <h3>Настройки профиля</h3>
            <label>Ник:</label>
            <input type="text" id="set-nick">
            <label>Username:</label>
            <input type="text" id="set-user">
            <label>Обои чата (URL):</label>
            <input type="text" id="set-bg" placeholder="url картинки">
            <button onclick="saveSettings()">Сохранить</button>
            <button style="background:#ff4d4d" onclick="supabase.auth.signOut().then(()=>location.reload())">Выйти</button>
            <button style="background:#ccc" onclick="closeModals()">Закрыть</button>
        </div>
    </div>

    <div id="viewer" class="viewer" onclick="this.style.display='none'">
        <div class="viewer-tools">
            <i class="material-icons" onclick="downloadFile(event)">file_download</i>
            <i class="material-icons">close</i>
        </div>
        <div id="viewer-content"></div>
    </div>

    <script>
        // --- КОНФИГ SUPABASE ---
        const SB_URL = 'https://uoypzlsxgzsjvhulzdpk.supabase.co';
        const SB_KEY = 'sb_publishable_yAAytU3jrrpSmOuG6-p2nA_AHnpfnFx';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        let user = null;
        let activeChat = null;
        let isReg = false;
        let currentViewUrl = '';

        // --- ЛОГИКА ВХОДА ---
        function toggleAuth() {
            isReg = !isReg;
            document.getElementById('reg-inputs').style.display = isReg ? 'block' : 'none';
            document.getElementById('auth-title').innerText = isReg ? 'Регистрация' : 'Tveeky';
            document.getElementById('btn-auth').innerText = isReg ? 'Создать' : 'Войти';
        }

        async function handleAuth() {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;

            if (isReg) {
                const nick = document.getElementById('reg-nickname').value;
                const user_at = document.getElementById('reg-username').value;

                // Проверка уникальности
                const { data: check } = await supabase.from('profiles').select('username').eq('username', user_at).single();
                if (check) return alert('Username уже занят!');

                const { data, error } = await supabase.auth.signUp({ email, password: pass });
                if (error) return alert(error.message);
                
                await supabase.from('profiles').insert({ id: data.user.id, full_name: nick, username: user_at });
                alert('Готово! Теперь войдите.');
                toggleAuth();
            } else {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
                if (error) return alert('Ошибка входа');
                initApp();
            }
        }

        async function initApp() {
            const { data } = await supabase.auth.getSession();
            if (!data.session) return;
            user = data.session.user;

            document.getElementById('screen-auth').classList.remove('active');
            document.getElementById('screen-main').classList.add('active');

            loadMyProfile();
            loadChats();
            subscribeToMessages();
        }

        async function loadMyProfile() {
            const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single();
            document.getElementById('my-name').innerText = data.full_name;
            document.getElementById('set-nick').value = data.full_name;
            document.getElementById('set-user').value = data.username;
        }

        // --- ЧАТЫ ---
        async function loadChats() {
            const { data: chats } = await supabase.from('chats').select('*');
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            chats.forEach(c => {
                const div = document.createElement('div');
                div.className = 'chat-item';
                div.innerHTML = `<img src="https://via.placeholder.com/50"> <span>${c.name}</span>`;
                div.onclick = () => selectChat(c);
                list.appendChild(div);
            });
        }

        function selectChat(chat) {
            activeChat = chat;
            document.getElementById('chat-header').style.visibility = 'visible';
            document.getElementById('input-bar').style.display = 'flex';
            document.getElementById('chat-title').innerText = chat.name;
            loadMessages(chat.id);
        }

        async function loadMessages(chatId) {
            const { data } = await supabase.from('messages').select('*').eq('chat_id', chatId).order('created_at', {ascending: true});
            const container = document.getElementById('msg-container');
            container.innerHTML = '';
            data.forEach(m => renderMsg(m));
        }

        function renderMsg(m) {
            const container = document.getElementById('msg-container');
            const isSent = m.user_id === user.id;
            const div = document.createElement('div');
            div.className = `msg ${isSent ? 'sent' : 'received'}`;
            
            let html = '';
            if (m.media_type === 'image') html += `<img src="${m.media_url}" onclick="openViewer('${m.media_url}', 'img')">`;
            if (m.media_type === 'video') html += `<video src="${m.media_url}" onclick="openViewer('${m.media_url}', 'vid')"></video>`;
            if (m.content) html += `<div>${m.content}</div>`;
            
            html += `<div class="msg-info">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} <span class="tick">✓✓</span></div>`;
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- ФУНКЦИИ ---
        async function sendText() {
            const val = document.getElementById('msg-input').value;
            if (!val || !activeChat) return;
            await supabase.from('messages').insert({ chat_id: activeChat.id, user_id: user.id, content: val });
            document.getElementById('msg-input').value = '';
        }

        async function uploadMedia(input) {
            const file = input.files[0];
            if (!file) return;
            const ext = file.name.split('.').pop();
            const path = `${Date.now()}.${ext}`;
            
            await supabase.storage.from('tveeky-media').upload(path, file);
            const { data } = supabase.storage.from('tveeky-media').getPublicUrl(path);
            
            await supabase.from('messages').insert({
                chat_id: activeChat.id,
                user_id: user.id,
                media_url: data.publicUrl,
                media_type: file.type.startsWith('image') ? 'image' : 'video'
            });
        }

        function openViewer(url, type) {
            currentViewUrl = url;
            const v = document.getElementById('viewer');
            const c = document.getElementById('viewer-content');
            c.innerHTML = type === 'img' ? `<img src="${url}">` : `<video src="${url}" controls autoplay></video>`;
            v.style.display = 'flex';
        }

        function downloadFile(e) {
            e.stopPropagation();
            window.open(currentViewUrl, '_blank');
        }

        function subscribeToMessages() {
            supabase.channel('messages').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, payload => {
                if (activeChat && payload.new.chat_id === activeChat.id) renderMsg(payload.new);
            }).subscribe();
        }

        // Настройки
        function showSettings() { document.getElementById('modal-settings').style.display='flex'; }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); }
        
        async function saveSettings() {
            const nick = document.getElementById('set-nick').value;
            const user_at = document.getElementById('set-user').value;
            const bg = document.getElementById('set-bg').value;

            const { error } = await supabase.from('profiles').update({ full_name: nick, username: user_at }).eq('id', user.id);
            if (error) return alert('Username занят!');
            
            if (bg) document.querySelector('.chat-window').style.backgroundImage = `url(${bg})`;
            alert('Сохранено!');
            closeModals();
            loadMyProfile();
        }

        window.onload = initApp;
    </script>
</body>
</html>
