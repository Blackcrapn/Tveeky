<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tveeky</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --tg-blue: #3390ec; --tg-bg: #f4f4f5; --msg-in: #ffffff; --msg-out: #eeffde; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: -apple-system, blinkmacsystemfont, "Segoe UI", roboto, sans-serif; overflow: hidden; }
        .hidden { display: none !important; }

        /* Auth Screen */
        #auth-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: #fff; z-index: 1000; position: relative; }
        .auth-box { width: 340px; text-align: center; padding: 30px; border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .auth-box h1 { color: var(--tg-blue); font-size: 35px; margin-bottom: 5px; }
        input, select { width: 100%; padding: 14px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; outline: none; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--tg-blue); color: #fff; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; }
        button:hover { opacity: 0.9; }

        /* Main App */
        #app { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 350px; background: #fff; border-right: 1px solid #dfe1e5; display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f0f0f0; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 15px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; }
        .chat-item:hover { background: #f4f4f5; }
        .chat-item img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .chat-item-info { flex: 1; }
        .chat-item-info b { font-size: 16px; }
        .chat-item-info p { margin: 0; font-size: 13px; color: #888; }

        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: #e6ebee; background-size: cover; position: relative; }
        .chat-header { padding: 10px 20px; background: #fff; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; }
        .chat-header img { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; }

        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 15px; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.my { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
        .msg-media { width: 100%; border-radius: 10px; cursor: pointer; margin-bottom: 5px; }
        .msg-time { font-size: 11px; color: #687a86; text-align: right; margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; }
        .msg-time .material-icons { font-size: 14px; margin-left: 4px; color: var(--tg-blue); }

        .input-bar { padding: 15px; background: #fff; display: flex; align-items: center; gap: 12px; }
        .input-bar input { flex: 1; border: none; padding: 10px; font-size: 16px; margin: 0; background: #f1f1f1; border-radius: 20px; }

        /* Fullscreen Viewer */
        #viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .v-top { position: absolute; top: 20px; right: 20px; display: flex; gap: 25px; color: #fff; }
        .v-top i { cursor: pointer; font-size: 30px; }
        #v-content img, #v-content video { max-width: 90vw; max-height: 85vh; border-radius: 5px; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; display: none; justify-content: center; align-items: center; }
        .modal-c { background: #fff; padding: 25px; border-radius: 20px; width: 350px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-box">
        <h1>Tveeky</h1>
        <p id="auth-hint">Введите почту для входа</p>
        <div id="auth-step-1">
            <input type="email" id="email" placeholder="Email (example@mail.com)">
            <button onclick="sendOTP()">Далее</button>
        </div>
        <div id="auth-step-2" class="hidden">
            <input type="text" id="otp" placeholder="Код из письма">
            <div id="reg-info" class="hidden">
                <input type="text" id="nick" placeholder="Имя профиля">
                <input type="text" id="user_at" placeholder="Username (уникальный)">
            </div>
            <button onclick="verifyOTP()">Войти</button>
        </div>
    </div>
</div>

<div id="app" class="hidden">
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="material-icons" onclick="showMod('set-mod')" style="cursor:pointer">menu</i>
            <b>Чаты</b>
            <i class="material-icons" onclick="showMod('add-mod')" style="cursor:pointer">add_circle_outline</i>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>
    
    <div class="chat-area" id="chat-bg">
        <div id="active-chat-h" class="chat-header hidden">
            <img id="active-img" src="https://ui-avatars.com/api/?name=T">
            <div>
                <b id="active-name">Чат</b><br>
                <small style="color:#888" id="active-status">online</small>
            </div>
        </div>
        
        <div class="messages" id="msgs">
            <div style="margin:auto; color:#888;">Выберите чат для общения</div>
        </div>

        <div class="input-bar hidden" id="input-ui">
            <label for="media-up"><i class="material-icons" style="color:#777; cursor:pointer">attach_file</i></label>
            <input type="file" id="media-up" hidden onchange="uploadFile(this)">
            <input type="text" id="m-text" placeholder="Сообщение...">
            <i class="material-icons" onclick="send()" style="color:var(--tg-blue); cursor:pointer">send</i>
        </div>
    </div>
</div>

<div id="viewer" onclick="this.style.display='none'">
    <div class="v-top">
        <i class="material-icons" onclick="downloadCur(event)">download</i>
        <i class="material-icons">close</i>
    </div>
    <div id="v-content"></div>
</div>

<div id="add-mod" class="modal" onclick="closeMod('add-mod')">
    <div class="modal-c" onclick="event.stopPropagation()">
        <h3>Создать</h3>
        <input type="text" id="new-g-name" placeholder="Название">
        <select id="new-g-type">
            <option value="group">Группа</option>
            <option value="channel">Канал</option>
        </select>
        <button onclick="createG()">Создать</button>
    </div>
</div>

<div id="set-mod" class="modal" onclick="closeMod('set-mod')">
    <div class="modal-c" onclick="event.stopPropagation()">
        <h3>Настройки</h3>
        <input type="text" id="s-nick" placeholder="Имя">
        <input type="text" id="s-user" placeholder="Username">
        <input type="text" id="s-wallpaper" placeholder="URL обоев чата">
        <button onclick="saveProfile()">Сохранить</button>
        <button style="background:#ff4d4d; margin-top:10px;" onclick="sb.auth.signOut().then(()=>location.reload())">Выйти</button>
    </div>
</div>

<script>
const SB_URL = 'YOUR_SUPABASE_URL';
const SB_KEY = 'YOUR_SUPABASE_KEY';
const sb = supabase.createClient(SB_URL, SB_KEY);

let me = null;
let activeChat = null;
let curMediaUrl = '';

// --- AUTH ---
async function sendOTP() {
    const email = document.getElementById('email').value;
    const { error } = await sb.auth.signInWithOtp({ email });
    if(error) return alert(error.message);
    document.getElementById('auth-step-1').classList.add('hidden');
    document.getElementById('auth-step-2').classList.remove('hidden');
    document.getElementById('auth-hint').innerText = "Код отправлен на почту";
    document.getElementById('reg-info').classList.remove('hidden');
}

async function verifyOTP() {
    const email = document.getElementById('email').value;
    const token = document.getElementById('otp').value;
    const { data, error } = await sb.auth.verifyOtp({ email, token, type: 'magiclink' });
    if(error) return alert("Код неверный!");
    
    me = data.user;
    const { data: p } = await sb.from('profiles').select('*').eq('id', me.id).single();
    if(!p) {
        const u = document.getElementById('user_at').value;
        const n = document.getElementById('nick').value;
        const { error: regErr } = await sb.from('profiles').insert({ id: me.id, username: u, full_name: n });
        if(regErr) return alert("Username уже занят!");
    }
    init();
}

async function init() {
    const { data: { session } } = await sb.auth.getSession();
    if(!session) return;
    me = session.user;
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    const { data: p } = await sb.from('profiles').select('*').eq('id', me.id).single();
    document.getElementById('s-nick').value = p.full_name;
    document.getElementById('s-user').value = p.username;
    if(p.chat_wallpaper) document.getElementById('chat-bg').style.backgroundImage = `url(${p.chat_wallpaper})`;

    loadChats();
    sb.channel('msgs').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, pl => {
        if(activeChat && pl.new.chat_id === activeChat.id) renderMsg(pl.new);
    }).subscribe();
}

// --- LOGIC ---
async function loadChats() {
    const { data } = await sb.from('chats').select('*').order('created_at', {ascending: false});
    const list = document.getElementById('chat-list');
    list.innerHTML = '';
    data.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `<img src="https://ui-avatars.com/api/?name=${c.name}">
            <div class="chat-item-info"><b>${c.name}</b><p>${c.type}</p></div>`;
        item.onclick = () => openChat(c);
        list.appendChild(item);
    });
}

function openChat(chat) {
    activeChat = chat;
    document.getElementById('active-chat-h').classList.remove('hidden');
    document.getElementById('input-ui').classList.remove('hidden');
    document.getElementById('active-name').innerText = chat.name;
    document.getElementById('active-img').src = `https://ui-avatars.com/api/?name=${chat.name}`;
    loadMessages();
}

async function loadMessages() {
    const { data } = await sb.from('messages').select('*').eq('chat_id', activeChat.id).order('created_at');
    document.getElementById('msgs').innerHTML = '';
    data.forEach(renderMsg);
}

function renderMsg(m) {
    const isMe = m.user_id === me.id;
    const d = document.createElement('div');
    d.className = `msg ${isMe ? 'my' : 'other'}`;
    let body = '';
    if(m.media_url) {
        if(m.media_type === 'image') body += `<img src="${m.media_url}" class="msg-media" onclick="view('${m.media_url}', 'img')">`;
        else body += `<video src="${m.media_url}" class="msg-media" onclick="view('${m.media_url}', 'vid')"></video>`;
    }
    if(m.content) body += `<div>${m.content}</div>`;
    body += `<div class="msg-time">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} <i class="material-icons">done_all</i></div>`;
    d.innerHTML = body;
    const box = document.getElementById('msgs');
    box.appendChild(d);
    box.scrollTop = box.scrollHeight;
}

async function send() {
    const txt = document.getElementById('m-text').value;
    if(!txt || !activeChat) return;
    await sb.from('messages').insert({ chat_id: activeChat.id, user_id: me.id, content: txt });
    document.getElementById('m-text').value = '';
}

async function uploadFile(input) {
    const file = input.files[0];
    const path = `${Date.now()}_${file.name}`;
    await sb.storage.from('tveeky-media').upload(path, file);
    const { data } = sb.storage.from('tveeky-media').getPublicUrl(path);
    await sb.from('messages').insert({ chat_id: activeChat.id, user_id: me.id, media_url: data.publicUrl, media_type: file.type.includes('image') ? 'image' : 'video' });
}

function view(u, t) {
    curMediaUrl = u;
    const v = document.getElementById('viewer');
    document.getElementById('v-content').innerHTML = t === 'img' ? `<img src="${u}">` : `<video src="${u}" controls autoplay></video>`;
    v.style.display = 'flex';
}

function downloadCur(e) { e.stopPropagation(); window.open(curMediaUrl, '_blank'); }

async function createG() {
    const name = document.getElementById('new-g-name').value;
    const type = document.getElementById('new-g-type').value;
    await sb.from('chats').insert({ name, type, owner_id: me.id });
    closeMod('add-mod'); loadChats();
}

async function saveProfile() {
    const n = document.getElementById('s-nick').value;
    const u = document.getElementById('s-user').value;
    const w = document.getElementById('s-wallpaper').value;
    const { error } = await sb.from('profiles').update({ full_name: n, username: u, chat_wallpaper: w }).eq('id', me.id);
    if(error) alert("Username занят!"); else location.reload();
}

function showMod(id) { document.getElementById(id).style.display = 'flex'; }
function closeMod(id) { document.getElementById(id).style.display = 'none'; }

window.onload = init;
</script>
</body>
</html>
