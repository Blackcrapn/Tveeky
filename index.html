<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tveeky Messenger</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --tg-blue: #3390ec;
            --bg: #f4f4f5;
            --sidebar-bg: #ffffff;
            --text: #000000;
            --msg-in: #ffffff;
            --msg-out: #eeffde;
            --border: #dfe1e5;
        }

        [data-theme="dark"] {
            --bg: #0f0f0f;
            --sidebar-bg: #1c1c1c;
            --text: #ffffff;
            --msg-in: #2b2b2b;
            --msg-out: #3d6a97;
            --border: #333333;
        }

        * { box-sizing: border-box; transition: background 0.2s, color 0.1s; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        .hidden { display: none !important; }

        /* AUTH SCREEN */
        #auth-screen { height: 100vh; display: flex; justify-content: center; align-items: center; background: var(--sidebar-bg); }
        .auth-card { width: 350px; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid var(--border); }
        .auth-card h1 { color: var(--tg-blue); font-size: 40px; margin: 0 0 10px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid var(--border); border-radius: 12px; background: var(--bg); color: var(--text); font-size: 16px; outline: none; }
        button { width: 100%; padding: 15px; background: var(--tg-blue); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; font-size: 16px; margin-top: 10px; }
        button:active { transform: scale(0.98); }

        /* MAIN LAYOUT */
        #app { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 380px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .search-bar { padding: 10px 15px; }
        .search-bar input { margin: 0; padding: 8px 15px; border-radius: 20px; font-size: 14px; }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 15px; display: flex; align-items: center; cursor: pointer; gap: 15px; border-bottom: 1px solid var(--border); }
        .chat-item:hover { background: rgba(0,0,0,0.05); }
        .chat-item img { width: 54px; height: 54px; border-radius: 50%; object-fit: cover; background: #ccc; }
        .chat-info { flex: 1; }
        .chat-info b { font-size: 16px; display: block; }
        .chat-info span { font-size: 13px; color: #888; }

        /* CHAT WINDOW */
        .chat-window { flex: 1; display: flex; flex-direction: column; background-size: cover; background-position: center; position: relative; }
        .chat-header { padding: 10px 20px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; z-index: 5; }
        .chat-header-info { display: flex; align-items: center; gap: 15px; }
        .chat-header img { width: 42px; height: 42px; border-radius: 50%; }

        .messages-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .msg { max-width: 65%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; color: #000; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        [data-theme="dark"] .msg { color: #fff; }
        .msg.sent { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 4px; }
        .msg img, .msg video { max-width: 100%; border-radius: 10px; cursor: pointer; margin-top: 5px; }
        .msg-meta { font-size: 11px; opacity: 0.6; display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 4px; }

        /* INPUT AREA */
        .input-area { padding: 15px 20px; background: var(--sidebar-bg); display: flex; align-items: center; gap: 15px; border-top: 1px solid var(--border); }
        .input-area input { flex: 1; margin: 0; background: var(--bg); border: none; padding: 12px 20px; border-radius: 25px; }

        /* VIEWER & MODALS */
        #viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .v-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 20px; color: white; cursor: pointer; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: none; justify-content: center; align-items: center; }
        .modal-body { background: var(--sidebar-bg); padding: 30px; border-radius: 20px; width: 380px; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="auth-card">
        <h1>Tveeky</h1>
        <p id="auth-text">Мессенджер нового поколения</p>
        <div id="auth-step-1">
            <input type="email" id="email" placeholder="Ваша почта...">
            <button onclick="sendOTP()">Продолжить</button>
        </div>
        <div id="auth-step-2" class="hidden">
            <input type="text" id="otp" placeholder="Код подтверждения">
            <div id="profile-setup" class="hidden">
                <input type="text" id="reg-nick" placeholder="Имя (Ник)">
                <input type="text" id="reg-user" placeholder="@username (уникальный)">
            </div>
            <button onclick="verifyOTP()" id="btn-verify">Войти</button>
        </div>
    </div>
</div>

<div id="app" class="hidden">
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="material-icons" onclick="showMod('settings-modal')" style="cursor:pointer">settings</i>
            <b style="font-size: 20px;">Tveeky</b>
            <i class="material-icons" onclick="showMod('create-modal')" style="cursor:pointer">add_circle</i>
        </div>
        <div class="search-bar"><input type="text" id="search" placeholder="Поиск чатов..." oninput="filterChats()"></div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="chat-window" id="chat-window">
        <div id="chat-header" class="chat-header hidden">
            <div class="chat-header-info">
                <img id="h-img" src="">
                <div><b id="h-name">Чат</b><br><small id="h-status" style="color:var(--tg-blue)">в сети</small></div>
            </div>
            <i class="material-icons" style="cursor:pointer" onclick="alert('Функция звонков в разработке')">videocam</i>
        </div>

        <div class="messages-area" id="msg-area">
            <div style="margin: auto; opacity: 0.5;">Выберите, кому хотите написать</div>
        </div>

        <div class="input-area hidden" id="input-ui">
            <label for="file-up"><i class="material-icons" style="cursor:pointer; color: #888;">add_photo_alternate</i></label>
            <input type="file" id="file-up" hidden onchange="handleFile(this)">
            <input type="text" id="m-input" placeholder="Напишите сообщение..." onkeypress="if(event.key==='Enter') send()">
            <i class="material-icons" style="color:var(--tg-blue); cursor:pointer; font-size: 30px;" onclick="send()">send</i>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal" onclick="closeMod('settings-modal')">
    <div class="modal-body" onclick="event.stopPropagation()">
        <h3>Настройки</h3>
        <label>Ник:</label><input type="text" id="s-nick">
        <label>Username:</label><input type="text" id="s-user">
        <label>Обои (URL):</label><input type="text" id="s-wall" placeholder="Прямая ссылка на фото">
        <button onclick="toggleTheme()" style="background: #555;">Сменить тему (День/Ночь)</button>
        <button onclick="saveProfile()">Сохранить изменения</button>
        <button onclick="sb.auth.signOut().then(()=>location.reload())" style="background:#e74c3c; margin-top:5px;">Выйти из аккаунта</button>
    </div>
</div>

<div id="create-modal" class="modal" onclick="closeMod('create-modal')">
    <div class="modal-body" onclick="event.stopPropagation()">
        <h3>Создать новое</h3>
        <input type="text" id="new-name" placeholder="Название группы или канала">
        <select id="new-type" style="width:100%; padding:12px; border-radius:10px; margin-bottom:10px; background:var(--bg); color:var(--text);">
            <option value="group">Группа (все пишут)</option>
            <option value="channel">Канал (пишет админ)</option>
        </select>
        <button onclick="createChat()">Создать</button>
    </div>
</div>

<div id="viewer" onclick="this.style.display='none'">
    <div class="v-actions">
        <i class="material-icons" onclick="downloadFile(event)">download</i>
        <i class="material-icons">close</i>
    </div>
    <div id="v-box"></div>
</div>

<script>
const SB_URL = 'https://uoypzlsxgzsjvhulzdpk.supabase.co';
const SB_KEY = 'sb_publishable_yAAytU3jrrpSmOuG6-p2nA_AHnpfnFx';
const sb = supabase.createClient(SB_URL, SB_KEY);

let me = null;
let activeChat = null;
let curMedia = '';

// --- AUTH LOGIC ---
async function sendOTP() {
    const email = document.getElementById('email').value;
    if(!email.includes('@')) return alert("Введите корректную почту!");
    
    const { error } = await sb.auth.signInWithOtp({ email });
    if(error) return alert("Ошибка: " + error.message);

    document.getElementById('auth-step-1').classList.add('hidden');
    document.getElementById('auth-step-2').classList.remove('hidden');
    document.getElementById('auth-text').innerText = "Код отправлен на " + email;

    // Проверяем существование профиля (технический хак для UI)
    document.getElementById('profile-setup').classList.remove('hidden');
}

async function verifyOTP() {
    const email = document.getElementById('email').value;
    const token = document.getElementById('otp').value;
    const { data, error } = await sb.auth.verifyOtp({ email, token, type: 'magiclink' });

    if(error) return alert("Неверный код!");
    
    me = data.user;
    const { data: p } = await sb.from('profiles').select('*').eq('id', me.id).single();
    
    if(!p) {
        const nick = document.getElementById('reg-nick').value;
        const userat = document.getElementById('reg-user').value;
        if(!nick || !userat) return alert("Заполните имя и юзернейм!");
        
        const { error: insErr } = await sb.from('profiles').insert({ id: me.id, full_name: nick, username: userat });
        if(insErr) return alert("Username уже занят!");
    }
    start();
}

async function start() {
    const { data: { session } } = await sb.auth.getSession();
    if(!session) return;
    me = session.user;

    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');

    const { data: p } = await sb.from('profiles').select('*').eq('id', me.id).single();
    document.getElementById('s-nick').value = p.full_name;
    document.getElementById('s-user').value = p.username;
    if(p.chat_wallpaper) document.getElementById('chat-window').style.backgroundImage = `url(${p.chat_wallpaper})`;
    
    if(localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');

    loadChats();
    setupRealtime();
}

// --- CHATS ---
async function loadChats() {
    const { data } = await sb.from('chats').select('*').order('created_at', {ascending: false});
    const list = document.getElementById('chat-list');
    list.innerHTML = '';
    data.forEach(c => {
        const item = document.createElement('div');
        item.className = 'chat-item';
        item.innerHTML = `<img src="https://ui-avatars.com/api/?name=${c.name}&background=random">
            <div class="chat-info"><b>${c.name}</b><span>${c.type === 'channel' ? 'канал' : 'группа'}</span></div>`;
        item.onclick = () => selectChat(c);
        list.appendChild(item);
    });
}

function selectChat(chat) {
    activeChat = chat;
    document.getElementById('chat-header').classList.remove('hidden');
    document.getElementById('input-ui').classList.remove('hidden');
    document.getElementById('h-name').innerText = chat.name;
    document.getElementById('h-img').src = `https://ui-avatars.com/api/?name=${chat.name}&background=random`;
    loadMessages();
}

async function loadMessages() {
    const { data } = await sb.from('messages').select('*').eq('chat_id', activeChat.id).order('created_at', {ascending: true});
    const area = document.getElementById('msg-area');
    area.innerHTML = '';
    data.forEach(renderMsg);
}

function renderMsg(m) {
    const isMe = m.user_id === me.id;
    const d = document.createElement('div');
    d.className = `msg ${isMe ? 'sent' : 'received'}`;
    
    let html = '';
    if(m.media_url) {
        if(m.media_type === 'image') html += `<img src="${m.media_url}" onclick="openView('${m.media_url}', 'img')">`;
        else html += `<video src="${m.media_url}" onclick="openView('${m.media_url}', 'vid')"></video>`;
    }
    if(m.content) html += `<div>${m.content}</div>`;
    html += `<div class="msg-meta">${new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} <span>✓✓</span></div>`;
    
    d.innerHTML = html;
    const area = document.getElementById('msg-area');
    area.appendChild(d);
    area.scrollTop = area.scrollHeight;
}

// --- ACTIONS ---
async function send() {
    const inp = document.getElementById('m-input');
    if(!inp.value || !activeChat) return;
    await sb.from('messages').insert({ chat_id: activeChat.id, user_id: me.id, content: inp.value });
    inp.value = '';
}

async function handleFile(input) {
    const file = input.files[0];
    const path = `media/${Date.now()}_${file.name}`;
    await sb.storage.from('tveeky-media').upload(path, file);
    const { data } = sb.storage.from('tveeky-media').getPublicUrl(path);
    await sb.from('messages').insert({ chat_id: activeChat.id, user_id: me.id, media_url: data.publicUrl, media_type: file.type.includes('image') ? 'image' : 'video' });
}

function openView(u, t) {
    curMedia = u;
    const box = document.getElementById('v-box');
    box.innerHTML = t==='img' ? `<img src="${u}">` : `<video src="${u}" controls autoplay></video>`;
    document.getElementById('viewer').style.display = 'flex';
}

function downloadFile(e) { e.stopPropagation(); window.open(curMedia, '_blank'); }

function toggleTheme() {
    const isDark = document.body.hasAttribute('data-theme');
    if(isDark) {
        document.body.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
    } else {
        document.body.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
    }
}

async function saveProfile() {
    const n = document.getElementById('s-nick').value;
    const u = document.getElementById('s-user').value;
    const w = document.getElementById('s-wall').value;
    await sb.from('profiles').update({ full_name: n, username: u, chat_wallpaper: w }).eq('id', me.id);
    location.reload();
}

async function createChat() {
    const name = document.getElementById('new-name').value;
    const type = document.getElementById('new-type').value;
    await sb.from('chats').insert({ name, type, owner_id: me.id });
    closeMod('create-modal');
    loadChats();
}

function setupRealtime() {
    sb.channel('db-changes').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, pl => {
        if(activeChat && pl.new.chat_id === activeChat.id) renderMsg(pl.new);
    }).subscribe();
}

function showMod(id) { document.getElementById(id).style.display = 'flex'; }
function closeMod(id) { document.getElementById(id).style.display = 'none'; }

window.onload = start;
</script>
</body>
</html>
